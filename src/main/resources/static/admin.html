<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DealHarbor Admin Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #2563eb;
      --danger: #dc2626;
      --success: #16a34a;
      --warning: #ea580c;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-600: #4b5563;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
    }
    
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    
    .login-box h1 {
      margin-bottom: 10px;
      font-size: 24px;
    }
    
    .login-box p {
      color: var(--gray-600);
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #1d4ed8;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    .alert {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .alert-error {
      background: #fee2e2;
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    
    .alert-success {
      background: #dcfce7;
      color: var(--success);
      border: 1px solid var(--success);
    }
    
    /* Dashboard Layout */
    .dashboard {
      display: none;
    }
    
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      height: 100vh;
      background: var(--gray-900);
      color: white;
      padding: 20px;
      overflow-y: auto;
    }
    
    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .nav-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .nav-item.active {
      background: var(--primary);
    }
    
    .main-content {
      margin-left: 250px;
      padding: 30px;
    }
    
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 28px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: var(--gray-600);
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-box input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
    }
    
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filters select {
      padding: 8px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: white;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table th {
      background: var(--gray-50);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-600);
      border-bottom: 2px solid var(--gray-200);
    }
    
    table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-200);
      font-size: 14px;
    }
    
    table tr:hover {
      background: var(--gray-50);
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-pending {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-approved {
      background: #dcfce7;
      color: #166534;
    }
    
    .badge-rejected {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge-sold {
      background: var(--gray-200);
      color: var(--gray-600);
    }
    
    .actions {
      display: flex;
      gap: 8px;
    }
    
    .hidden { display: none !important; }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .pagination button {
      padding: 8px 16px;
      border: 1px solid var(--gray-200);
      background: white;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray-600);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-600);
    }
    
    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    img.thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <div class="login-box">
      <h1>üõ°Ô∏è Admin Dashboard</h1>
      <p>Sign in with your admin credentials</p>
      
      <div id="loginError" class="alert alert-error hidden"></div>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" required placeholder="admin@dealharbor.com">
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required placeholder="Enter password">
        </div>
        
        <button type="submit" class="btn btn-primary">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardScreen" class="dashboard">
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>DealHarbor Admin</h2>
      
      <div class="nav-item active" onclick="showSection('overview')">
        üìä Overview
      </div>
      <div class="nav-item" onclick="showSection('products')">
        üì¶ Products
      </div>
      <div class="nav-item" onclick="showSection('users')">
        üë• Users
      </div>
      <div class="nav-item" onclick="logout()">
        üö™ Logout
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1 id="pageTitle">Dashboard Overview</h1>
        <div id="adminInfo"></div>
      </div>

      <!-- Overview Section -->
      <div id="overviewSection" class="section">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Products</h3>
            <div class="value" id="totalProducts">-</div>
          </div>
          <div class="stat-card">
            <h3>Pending Approval</h3>
            <div class="value" id="pendingProducts">-</div>
          </div>
          <div class="stat-card">
            <h3>Total Users</h3>
            <div class="value" id="totalUsers">-</div>
          </div>
          <div class="stat-card">
            <h3>Active Today</h3>
            <div class="value" id="activeToday">-</div>
          </div>
        </div>

        <div class="card">
          <h2>Quick Actions</h2>
          <div class="actions">
            <button class="btn btn-primary" onclick="showSection('products')">Review Pending Products</button>
            <button class="btn btn-primary" onclick="showSection('users')">Manage Users</button>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div id="productsSection" class="section hidden">
        <div class="card">
          <h2>Product Management</h2>
          
          <div class="search-box">
            <input type="text" id="productSearch" placeholder="Search products...">
            <button class="btn btn-primary" onclick="searchProducts()">Search</button>
          </div>

          <div class="filters">
            <select id="productStatusFilter" onchange="loadProducts()">
              <option value="">All Status</option>
              <option value="PENDING" selected>Pending</option>
              <option value="APPROVED">Approved</option>
              <option value="REJECTED">Rejected</option>
              <option value="SOLD">Sold</option>
            </select>
            
            <button class="btn btn-sm" onclick="loadProducts()">Refresh</button>
          </div>

          <div id="productsLoading" class="loading hidden">Loading...</div>
          <div id="productsEmpty" class="empty-state hidden">
            <h3>No products found</h3>
            <p>Try changing the filters</p>
          </div>

          <table id="productsTable" class="hidden">
            <thead>
              <tr>
                <th>Image</th>
                <th>Title</th>
                <th>Price</th>
                <th>Seller</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productsBody"></tbody>
          </table>

          <div id="productsPagination" class="pagination hidden"></div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="usersSection" class="section hidden">
        <div class="card">
          <h2>User Management</h2>
          
          <div class="search-box">
            <input type="text" id="userSearch" placeholder="Search users...">
            <button class="btn btn-primary" onclick="searchUsers()">Search</button>
          </div>

          <div class="filters">
            <select id="userFilter" onchange="loadUsers()">
              <option value="all">All Users</option>
              <option value="verified">Verified Students</option>
              <option value="banned">Banned</option>
            </select>
            
            <button class="btn btn-sm" onclick="loadUsers()">Refresh</button>
          </div>

          <div id="usersLoading" class="loading hidden">Loading...</div>
          <div id="usersEmpty" class="empty-state hidden">
            <h3>No users found</h3>
            <p>Try changing the filters</p>
          </div>

          <table id="usersTable" class="hidden">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Verified</th>
                <th>Joined</th>
                <th>Listings</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersBody"></tbody>
          </table>

          <div id="usersPagination" class="pagination hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080/api';
    let currentUser = null;
    let currentPage = { products: 0, users: 0 };

    // Auth Functions
    async function login(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!response.ok) {
          throw new Error('Invalid credentials');
        }

        const data = await response.json();
        
        // Extract user from response (login returns {message, user})
        const user = data.user || data;
        
        // Check if user is admin
        if (user.role !== 'ADMIN') {
          throw new Error('Access denied. Admin role required.');
        }

        currentUser = user;
        showDashboard();
      } catch (error) {
        const errorEl = document.getElementById('loginError');
        errorEl.textContent = error.message;
        errorEl.classList.remove('hidden');
      }
    }

    async function logout() {
      try {
        await fetch(`${API_BASE}/auth/logout`, {
          method: 'POST',
          credentials: 'include'
        });
      } catch (error) {
        console.error('Logout error:', error);
      }
      
      currentUser = null;
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('dashboardScreen').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboardScreen').style.display = 'block';
      document.getElementById('adminInfo').textContent = `üë§ ${currentUser.name}`;
      
      loadDashboardStats();
      showSection('overview');
    }

    // Navigation
    function showSection(section) {
      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event?.target?.classList.add('active');

      // Hide all sections
      document.querySelectorAll('.section').forEach(sec => {
        sec.classList.add('hidden');
      });

      // Show selected section
      const sectionMap = {
        'overview': 'overviewSection',
        'products': 'productsSection',
        'users': 'usersSection'
      };

      document.getElementById(sectionMap[section]).classList.remove('hidden');

      // Update page title
      const titles = {
        'overview': 'Dashboard Overview',
        'products': 'Product Management',
        'users': 'User Management'
      };
      document.getElementById('pageTitle').textContent = titles[section];

      // Load data
      if (section === 'products') {
        loadProducts();
      } else if (section === 'users') {
        loadUsers();
      }
    }

    // Dashboard Stats
    async function loadDashboardStats() {
      try {
        const response = await fetch(`${API_BASE}/admin/dashboard`, {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load stats');

        const stats = await response.json();
        
        document.getElementById('totalProducts').textContent = stats.totalProducts || 0;
        document.getElementById('pendingProducts').textContent = stats.pendingApprovalProducts || 0;
        document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
        document.getElementById('activeToday').textContent = stats.activeUsersToday || 0;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Products Management
    async function loadProducts() {
      const status = document.getElementById('productStatusFilter').value;
      const page = currentPage.products;
      
      showLoading('products');

      try {
        let url = `${API_BASE}/admin/products?page=${page}&size=20&sortBy=date_desc`;
        if (status) url += `&status=${status}`;

        const response = await fetch(url, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load products');

        const data = await response.json();
        renderProducts(data);
      } catch (error) {
        console.error('Error loading products:', error);
        showEmpty('products');
      }
    }

    function renderProducts(data) {
      const tbody = document.getElementById('productsBody');
      tbody.innerHTML = '';

      if (!data.content || data.content.length === 0) {
        showEmpty('products');
        return;
      }

      hideLoading('products');
      document.getElementById('productsTable').classList.remove('hidden');

      data.content.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            ${product.primaryImageUrl 
              ? `<img src="${API_BASE.replace('/api', '')}${product.primaryImageUrl}" class="thumbnail" alt="${product.title}">` 
              : '<div class="thumbnail" style="background:#e5e7eb"></div>'}
          </td>
          <td>
            <strong>${product.title}</strong><br>
            <small style="color:#6b7280">${product.categoryName}</small>
          </td>
          <td>‚Çπ${product.price.toLocaleString('en-IN')}</td>
          <td>${product.sellerName}</td>
          <td><span class="badge badge-${product.status.toLowerCase()}">${product.status}</span></td>
          <td>${new Date(product.createdAt).toLocaleDateString()}</td>
          <td>
            <div class="actions">
              ${product.status === 'PENDING' ? `
                        <button class="btn btn-sm btn-success" onclick="approveProduct('${product.id}')">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectProduct('${product.id}')">Reject</button>
                      ` : ''}
                      <button class="btn btn-sm" onclick="viewProduct('${product.id}')">View</button>
                      ${product.status !== 'DELETED' ? `
                        <button class="btn btn-sm" onclick="toggleFeatured('${product.id}', ${product.isFeatured})">${product.isFeatured ? 'Unfeature' : 'Feature'}</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
                      ` : ''}
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });

      renderPagination('products', data);
    }

    async function approveProduct(productId) {
      if (!confirm('Approve this product?')) return;

      try {
        const response = await fetch(`${API_BASE}/admin/products/${productId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'APPROVED' })
        });

        if (!response.ok) throw new Error('Failed to approve');

        alert('Product approved successfully!');
        loadProducts();
        loadDashboardStats();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function rejectProduct(productId) {
      const reason = prompt('Reason for rejection (optional):');
      if (reason === null) return;

      try {
        const response = await fetch(`${API_BASE}/admin/products/${productId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'REJECTED', reason })
        });

        if (!response.ok) throw new Error('Failed to reject');

        alert('Product rejected!');
        loadProducts();
        loadDashboardStats();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function viewProduct(productId) {
      window.open(`http://localhost:8080/api/products/${productId}`, '_blank');
    }

    async function toggleFeatured(productId, isCurrentlyFeatured) {
      try {
        const response = await fetch(`${API_BASE}/admin/products/${productId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isFeatured: !isCurrentlyFeatured })
        });

        if (!response.ok) throw new Error('Failed to update featured status');

        alert('Featured status updated.');
        loadProducts();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function deleteProduct(productId) {
      if (!confirm('Delete this product? This cannot be undone.')) return;
      try {
        const response = await fetch(`${API_BASE}/admin/products/${productId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'DELETED', reason: 'Removed by admin' })
        });

        if (!response.ok) throw new Error('Failed to delete product');

        alert('Product deleted.');
        loadProducts();
        loadDashboardStats();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function searchProducts() {
      const keyword = document.getElementById('productSearch').value.trim();
      if (!keyword) {
        loadProducts();
        return;
      }

      showLoading('products');

      try {
        const response = await fetch(
          `${API_BASE}/admin/products/search?keyword=${encodeURIComponent(keyword)}&page=0&size=20`,
          { credentials: 'include' }
        );

        if (!response.ok) throw new Error('Search failed');

        const data = await response.json();
        renderProducts(data);
      } catch (error) {
        console.error('Search error:', error);
        showEmpty('products');
      }
    }

    // Users Management
    async function loadUsers() {
      const filter = document.getElementById('userFilter').value;
      const page = currentPage.users;
      
      showLoading('users');

      try {
        const response = await fetch(
          `${API_BASE}/admin/users?filter=${filter}&page=${page}&size=20`,
          { credentials: 'include' }
        );

        if (!response.ok) throw new Error('Failed to load users');

        const data = await response.json();
        renderUsers(data);
      } catch (error) {
        console.error('Error loading users:', error);
        showEmpty('users');
      }
    }

    function renderUsers(data) {
      const tbody = document.getElementById('usersBody');
      tbody.innerHTML = '';

      if (!data.content || data.content.length === 0) {
        showEmpty('users');
        return;
      }

      hideLoading('users');
      document.getElementById('usersTable').classList.remove('hidden');

      data.content.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td><span class="badge badge-${user.role === 'ADMIN' ? 'approved' : 'pending'}">${user.role}</span></td>
          <td>${user.isVerifiedStudent ? '‚úÖ Yes' : '‚ùå No'}</td>
          <td>${new Date(user.createdAt).toLocaleDateString()}</td>
          <td>${user.totalListings || 0}</td>
          <td>
            <div class="actions">
              ${!user.isBanned ? `
                <button class="btn btn-sm btn-danger" onclick="banUser('${user.id}')">Ban</button>
              ` : `
                <button class="btn btn-sm btn-success" onclick="unbanUser('${user.id}')">Unban</button>
              `}
              <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });

      renderPagination('users', data);
    }

    async function deleteUser(userId) {
      if (!confirm('Delete this user and all their listings? This action is reversible only via DB.')) return;
      try {
        const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'DELETE_ACCOUNT', reason: 'Deleted by admin' })
        });

        if (!response.ok) throw new Error('Failed to delete user');

        alert('User deleted.');
        loadUsers();
        loadDashboardStats();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function banUser(userId) {
      const reason = prompt('Reason for ban:');
      if (!reason) return;

      try {
        const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'BAN', reason })
        });

        if (!response.ok) throw new Error('Failed to ban user');

        alert('User banned successfully!');
        loadUsers();
        loadDashboardStats();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function unbanUser(userId) {
      if (!confirm('Unban this user?')) return;

      try {
        const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'UNBAN' })
        });

        if (!response.ok) throw new Error('Failed to unban user');

        alert('User unbanned successfully!');
        loadUsers();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function searchUsers() {
      const keyword = document.getElementById('userSearch').value.trim();
      if (!keyword) {
        loadUsers();
        return;
      }

      showLoading('users');

      try {
        const response = await fetch(
          `${API_BASE}/admin/users/search?keyword=${encodeURIComponent(keyword)}&page=0&size=20`,
          { credentials: 'include' }
        );

        if (!response.ok) throw new Error('Search failed');

        const data = await response.json();
        renderUsers(data);
      } catch (error) {
        console.error('Search error:', error);
        showEmpty('users');
      }
    }

    // Pagination (adapted to backend PagedResponse fields: page, size, totalElements, totalPages, first, last)
    function renderPagination(type, data) {
      const container = document.getElementById(`${type}Pagination`);
      container.classList.remove('hidden');

      const page = data.page ?? 0;
      const totalPages = data.totalPages ?? 1;
      const isFirst = data.first === true;
      const isLast = data.last === true;

      container.innerHTML = `
        <button ${isFirst ? 'disabled' : ''} onclick="changePage('${type}', ${page - 1})">Previous</button>
        <span>Page ${page + 1} of ${totalPages}</span>
        <button ${isLast ? 'disabled' : ''} onclick="changePage('${type}', ${page + 1})">Next</button>
      `;
    }

    function changePage(type, page) {
      if (page < 0) page = 0;
      if (type === 'products') {
        currentPage.products = page;
        loadProducts();
      } else if (type === 'users') {
        currentPage.users = page;
        loadUsers();
      }
    }

    // UI Helpers
    function showLoading(type) {
      document.getElementById(`${type}Loading`).classList.remove('hidden');
      document.getElementById(`${type}Table`).classList.add('hidden');
      document.getElementById(`${type}Empty`).classList.add('hidden');
      document.getElementById(`${type}Pagination`).classList.add('hidden');
    }

    function hideLoading(type) {
      document.getElementById(`${type}Loading`).classList.add('hidden');
    }

    function showEmpty(type) {
      hideLoading(type);
      document.getElementById(`${type}Empty`).classList.remove('hidden');
      document.getElementById(`${type}Table`).classList.add('hidden');
      document.getElementById(`${type}Pagination`).classList.add('hidden');
    }

    // Init
    document.getElementById('loginForm').addEventListener('submit', login);
    
    // Check if already logged in
    (async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
        if (response.ok) {
          const user = await response.json();
          if (user.role === 'ADMIN') {
            currentUser = user;
            showDashboard();
          }
        }
      } catch (error) {
        // Not logged in, show login screen
      }
    })();
  </script>
</body>
</html>
